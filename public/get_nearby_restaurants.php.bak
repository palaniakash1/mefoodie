<?php
require_once('../private/initialize.php');

header('Content-Type: application/json');
error_reporting(E_ALL);
ini_set('display_errors', 1);

$lat = isset($_GET['lat']) ? floatval($_GET['lat']) : null;
$lon = isset($_GET['lon']) ? floatval($_GET['lon']) : null;

try {
    if ($lat !== null && $lon !== null) {
        $stmt = $db->connection->prepare("
            SELECT *,
                (6371 * acos(
                    cos(radians(?)) * cos(radians(latitude)) *
                    cos(radians(longitude) - radians(?)) +
                    sin(radians(?)) * sin(radians(latitude))
                )) AS distance
            FROM businesses
            WHERE status = 'approved'
            ORDER BY distance ASC
        ");
        $stmt->bind_param("ddd", $lat, $lon, $lat);
    } else {
        $stmt = $db->connection->prepare("
            SELECT * FROM businesses
            WHERE status = 'approved'
            ORDER BY name ASC
        ");
    }

    $stmt->execute();
    $result = $stmt->get_result();
    $businesses = [];

    while ($row = $result->fetch_assoc()) {
        if (is_string($row['tags'])) {
            $decoded = json_decode($row['tags'], true);
            $row['tags'] = $decoded ?: $row['tags'];
        }
        $businesses[] = $row;
    }

    echo json_encode($businesses);
} catch (Exception $e) {
    echo json_encode(["error" => $e->getMessage()]);
}
